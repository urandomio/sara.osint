---
import fs from 'node:fs';
import path from 'node:path';
import BaseLayout from '../layouts/BaseLayout.astro';

const base = import.meta.env.BASE_URL;

const pagesRoot = path.resolve('src/pages');

function walk(dir: string): string[] {
  const entries = fs.readdirSync(dir, { withFileTypes: true });
  const out: string[] = [];
  for (const e of entries) {
    const full = path.join(dir, e.name);
    if (e.isDirectory()) out.push(...walk(full));
    else if (e.isFile() && e.name.endsWith('.astro')) out.push(full);
  }
  return out;
}

function routeFromFile(filePath: string): string {
  const rel = path.relative(pagesRoot, filePath).replaceAll(path.sep, '/');

  // /index
  if (rel === 'index.astro') return '/';

  // /foo
  if (rel.endsWith('/index.astro')) return '/' + rel.slice(0, -'/index.astro'.length);

  // /foo/bar
  return '/' + rel.slice(0, -'.astro'.length);
}

function hrefForRoute(route: string): string {
  if (route === '/') return base;
  return base + route.slice(1);
}

function titleCase(s: string): string {
  return s
    .split(/[-_ ]+/g)
    .filter(Boolean)
    .map((w) => w.slice(0, 1).toUpperCase() + w.slice(1))
    .join(' ');
}

function labelForRoute(route: string): string {
  if (route === '/') return 'Home';
  const segs = route.split('/').filter(Boolean);
  const last = segs[segs.length - 1] ?? route;
  return titleCase(last);
}

const ignore = new Set<string>([
  '/',
]);

const routes = walk(pagesRoot)
  .map(routeFromFile)
  .filter((r) => !ignore.has(r))
  .filter((r) => !r.endsWith('/404'))
  .filter((r) => r !== '/Welcome');

// Group by top-level segment
const groups: Map<string, string[]> = new Map();
for (const r of routes) {
  const seg = r.split('/').filter(Boolean)[0] ?? 'other';
  const group = seg;
  const list = groups.get(group) ?? [];
  list.push(r);
  groups.set(group, list);
}

const order = [
  'blog',
  'web-based-tools',
  'osint-clearnet',
  'osint-darknet',
  'investigative-journalism',
  'document-forensics',
  'osint-professionals',
  'osint-challenges',
  'bloginfo',
  'mental-health',
];

const groupNames = Array.from(groups.keys()).sort((a, b) => {
  const ia = order.indexOf(a);
  const ib = order.indexOf(b);
  if (ia !== -1 && ib !== -1) return ia - ib;
  if (ia !== -1) return -1;
  if (ib !== -1) return 1;
  return a.localeCompare(b);
});

for (const k of groupNames) {
  groups.get(k)?.sort((a, b) => a.localeCompare(b));
}
---

<BaseLayout title="Index - Sara's OSINT Resources" description="Browse all imported pages and sections">
  <article class="surface p-6 sm:p-10 prose prose-invert max-w-none">
    <h1 class="gradient-text mb-8 text-5xl font-bold">Index</h1>

    <p>
      This is a human-friendly listing of all sections/pages currently in the site.
      (Useful because the top nav stays intentionally short.)
    </p>

    <div class="not-prose mt-10 grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
      {groupNames.map((g) => (
        <section class="rounded-2xl border border-white/10 bg-white/5 p-5">
          <h2 class="text-base font-semibold tracking-wide text-zinc-100">{titleCase(g)}</h2>
          <ul class="mt-3 space-y-2 text-sm">
            {(groups.get(g) ?? []).map((r) => (
              <li>
                <a class="focus-ring text-cyan-300 hover:text-cyan-200" href={hrefForRoute(r)}>
                  {labelForRoute(r)}
                </a>
                <span class="ml-2 text-xs text-zinc-400">{r}</span>
              </li>
            ))}
          </ul>
        </section>
      ))}
    </div>
  </article>
</BaseLayout>
